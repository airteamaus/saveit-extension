name: Release Extension

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for release notes generation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Checkout saveit-backend (private repo)
        uses: actions/checkout@v4
        with:
          repository: airteamaus/saveit-backend
          ssh-key: ${{ secrets.BACKEND_DEPLOY_KEY }}
          path: ../saveit-backend

      - name: Install backend dependencies
        run: cd ../saveit-backend/graph-viz && npm install

      - name: Add build date to manifest
        run: |
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Add build_date field to manifest.json using jq
          jq --arg date "$BUILD_DATE" '. + {build_date: $date}' manifest.json > manifest.tmp && mv manifest.tmp manifest.json
          echo "Added build_date: $BUILD_DATE"

      - name: Build bundles
        run: node scripts/bundle-firebase.js && node scripts/bundle-graph.js

      - name: Build Chrome extension (unsigned zip)
        run: |
          # Build creates universal package that works for both Firefox and Chrome
          # Chrome will use service_worker, Firefox will use scripts array
          npx web-ext build --overwrite-dest

      - name: Build and sign Firefox extension
        env:
          AMO_JWT_ISSUER: ${{ secrets.AMO_JWT_ISSUER }}
          AMO_JWT_SECRET: ${{ secrets.AMO_JWT_SECRET }}
        run: |
          npx web-ext sign \
            --source-dir=. \
            --channel=unlisted \
            --api-key="$AMO_JWT_ISSUER" \
            --api-secret="$AMO_JWT_SECRET"

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Find and rename signed XPI
        id: find_xpi
        run: |
          XPI_PATH=$(find web-ext-artifacts -name "*.xpi" -type f | head -n 1)
          XPI_NAME="saveit-${{ steps.get_version.outputs.VERSION }}.xpi"
          mv "$XPI_PATH" "$XPI_NAME"
          echo "XPI_NAME=$XPI_NAME" >> $GITHUB_OUTPUT

      - name: Find and rename Chrome ZIP
        id: find_zip
        run: |
          ZIP_PATH=$(find web-ext-artifacts -name "*.zip" -type f | head -n 1)
          ZIP_NAME="saveit-chrome-${{ steps.get_version.outputs.VERSION }}.zip"
          mv "$ZIP_PATH" "$ZIP_NAME"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          # Generate release notes from conventional commits
          NOTES=$(node scripts/generate-changelog.js release-notes "$VERSION" || echo "")

          if [ -z "$NOTES" ]; then
            NOTES="No notable changes in this release."
          fi

          # Save to file for multiline handling
          echo "$NOTES" > release-notes.tmp

          # Set output (handle multiline)
          {
            echo 'NOTES<<EOF'
            cat release-notes.tmp
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.find_xpi.outputs.XPI_NAME }}
            ${{ steps.find_zip.outputs.ZIP_NAME }}
          draft: false
          prerelease: false
          body: |
            ${{ steps.release_notes.outputs.NOTES }}

            ---

            ## ðŸ“¦ Downloads

            ### ðŸ¦Š Firefox (Recommended - Auto-updates enabled)
            **Download:** `saveit-${{ steps.get_version.outputs.VERSION }}.xpi` âœ… Signed by Mozilla

            **Installation:**
            1. Click the `.xpi` file to download
            2. Firefox will prompt to install
            3. Click "Add" to confirm
            4. Extension will auto-update when new versions are released

            ---

            ### ðŸŒ Chrome / Brave / Edge (Developer Mode - Manual updates)
            **Download:** `saveit-chrome-${{ steps.get_version.outputs.VERSION }}.zip` âš ï¸ Unsigned (for testing/sideloading)

            **Installation:**
            1. Download and **extract** the `.zip` file
            2. Open your browser's extensions page:
               - Chrome: `chrome://extensions`
               - Brave: `brave://extensions`
               - Edge: `edge://extensions`
            3. Enable **"Developer mode"** (toggle in top right)
            4. Click **"Load unpacked"**
            5. Select the **extracted folder** (the folder containing `manifest.json`)

            **Note:** Chrome builds are unsigned and require developer mode. You'll need to manually download and install new versions when they're released.

            ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update updates.json
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          REPO="${{ github.repository }}"

          # Fetch and checkout main to avoid detached HEAD issues
          git fetch origin main
          git checkout main
          git pull origin main

          cat > updates.json << EOF
          {
            "addons": {
              "saveit@airteam.com.au": {
                "updates": [
                  {
                    "version": "$VERSION",
                    "update_link": "https://github.com/$REPO/releases/download/v$VERSION/saveit-$VERSION.xpi"
                  }
                ]
              }
            }
          }
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add updates.json
          git commit -m "Update updates.json for v$VERSION [skip ci]"
          git push origin main
