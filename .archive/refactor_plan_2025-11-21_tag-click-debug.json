{
  "project": "Debug Tag Click Highlighting & Similarity Sorting",
  "created": "2025-11-21",
  "status": "completed",
  "completed_date": "2025-11-21",
  "current_phase": null,
  "current_task": null,
  "goal": "Fix tag clicking bugs: missing L2 tags and poor similarity results",

  "context": {
    "issue": "Clicking tags in newtab.html doesn't show L2 tags or sort by similarity correctly",
    "root_causes": [
      "ES6 import in api.js broke module loading (dashboard failed to initialize)",
      "L2/L3 tag extraction used filteredPages instead of allPages",
      "Representative selection used first page instead of best page"
    ],
    "architecture": "Tag click → Find best representative → Backend vector search → Pre-sorted results",
    "recent_changes": "Commit e61ee3b added ES6 import without converting api.js to module (Nov 21)"
  },

  "root_cause_analysis": {
    "bug_1": {
      "symptom": "Dashboard fails to load with 'API is not defined' error",
      "cause": "api.js line 5 used ES6 import but was loaded as regular script (not module)",
      "introduced_by": "Commit e61ee3b - refactor: consolidate browser API detection in config.js",
      "why_it_broke": "Added 'import { getBrowserRuntime, getStorageAPI } from config.js' without adding type='module' to script tag",
      "fix": "Removed ES6 import, use global variables provided by config-loader.js instead",
      "files_changed": ["src/api.js"]
    },
    "bug_2": {
      "symptom": "L2 domain tags don't show after clicking L1 general tag",
      "cause": "extractL2TagsForL1() used filteredPages (similarity results) instead of allPages",
      "why_it_broke": "Similarity results (50 pages) don't contain all L2 tags that exist under L1",
      "fix": "Changed to use allPages for tag extraction, filteredPages only for display",
      "files_changed": ["src/tag-interaction-manager.js:83-99"]
    },
    "bug_3": {
      "symptom": "Similarity search returns wrong results (mosaic.so for Publishing)",
      "cause": "_findThingWithTag() used pages.find() which returns FIRST page, not BEST page",
      "why_it_broke": "First page could be any random page with tag (e.g., mosaic.so mentions publishing)",
      "fix": "Find all pages with tag, select page with most tags (best classified = best representative)",
      "files_changed": ["src/tag-interaction-manager.js:228-266"]
    }
  },

  "phases": [
    {
      "id": "phase-1",
      "name": "Verify CSS & Event Handling",
      "status": "in_progress",
      "description": "Ensure visual highlighting and event listeners work",
      "tasks": [
        {
          "id": "task-1-1",
          "type": "investigate",
          "description": "Verify CSS rules for .tag.active exist and apply correctly",
          "status": "pending",
          "files_referenced": ["src/newtab.css"],
          "completion_criteria": [
            "Find .tag.active CSS rules in newtab.css",
            "Confirm styles are visible (color change, background, border, etc.)",
            "Test in browser DevTools that class applies"
          ]
        },
        {
          "id": "task-1-2",
          "type": "investigate",
          "description": "Verify event delegation attaches correctly",
          "status": "pending",
          "files_referenced": ["src/event-manager.js:114-145"],
          "completion_criteria": [
            "Check browser console for errors during init",
            "Verify setupEventListeners() completes without errors",
            "Test click handler fires (add console.log temporarily)"
          ]
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Verify Backend API Calls",
      "status": "pending",
      "description": "Ensure similarity search API works correctly",
      "tasks": [
        {
          "id": "task-2-1",
          "type": "investigate",
          "description": "Verify getSimilarByThingId API call succeeds",
          "status": "pending",
          "files_referenced": ["src/tag-interaction-manager.js:197", "src/api.js:574-600"],
          "completion_criteria": [
            "Check Network tab for API call to ?thing_id=X",
            "Verify response has results array",
            "Confirm response.results has similarity scores",
            "Check for authentication errors (401/403)"
          ]
        },
        {
          "id": "task-2-2",
          "type": "investigate",
          "description": "Verify similarity results extraction",
          "status": "pending",
          "files_referenced": ["src/tag-interaction-manager.js:212-222", "src/tag-interaction-manager.js:250-289"],
          "completion_criteria": [
            "Confirm _extractSimilarityResults() receives data",
            "Verify pages array has _similarity scores attached",
            "Check that pages are pre-sorted by backend"
          ]
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Verify State Management",
      "status": "pending",
      "description": "Ensure selection state and rendering work correctly",
      "tasks": [
        {
          "id": "task-3-1",
          "type": "investigate",
          "description": "Verify selection state updates on tag click",
          "status": "pending",
          "files_referenced": ["src/tag-interaction-manager.js:151-164"],
          "completion_criteria": [
            "Check selectedL1/L2/L3 update correctly",
            "Verify getSelection() returns active tag",
            "Confirm renderTagBar() receives updated state"
          ]
        },
        {
          "id": "task-3-2",
          "type": "investigate",
          "description": "Verify renderTagBar applies 'active' class",
          "status": "pending",
          "files_referenced": ["src/tag-interaction-manager.js:54-112"],
          "completion_criteria": [
            "Check isActive comparison logic (line 72, 86, 99)",
            "Verify activeClass variable is 'active' string",
            "Confirm HTML string includes active class in output"
          ]
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "Test Environment Isolation",
      "status": "pending",
      "description": "Rule out environment-specific issues",
      "tasks": [
        {
          "id": "task-4-1",
          "type": "investigate",
          "description": "Test in standalone mode (file:// protocol)",
          "status": "pending",
          "files_referenced": ["src/newtab.html"],
          "completion_criteria": [
            "Open src/newtab.html directly in browser",
            "Test tag clicking with mock data",
            "Verify highlighting works in standalone mode",
            "Compare behavior to extension mode"
          ]
        },
        {
          "id": "task-4-2",
          "type": "investigate",
          "description": "Verify Firebase authentication in extension mode",
          "status": "pending",
          "files_referenced": ["src/firebase-auth-manager.js"],
          "completion_criteria": [
            "Check getCurrentUser() returns valid user",
            "Verify idToken is available for API calls",
            "Confirm no auth errors in console"
          ]
        }
      ]
    },
    {
      "id": "phase-5",
      "name": "Fix Identified Issues",
      "status": "pending",
      "description": "Implement fixes based on findings",
      "tasks": [
        {
          "id": "task-5-1",
          "type": "implement",
          "description": "Fix root cause (TBD based on investigation)",
          "status": "pending",
          "files_referenced": [],
          "files_changed": [],
          "completion_criteria": [
            "Root cause identified",
            "Fix implemented",
            "Tests pass",
            "Tag clicking highlights correctly",
            "Similarity sorting works"
          ]
        }
      ]
    }
  ],

  "fix_summary": {
    "files_changed": ["src/api.js", "src/tag-interaction-manager.js"],
    "total_line_changes": 47,
    "changes": [
      {
        "file": "src/api.js",
        "lines": "5-6",
        "description": "Removed ES6 import, use global variables from config-loader.js"
      },
      {
        "file": "src/tag-interaction-manager.js",
        "lines": "83-99",
        "description": "Changed L2/L3 tag extraction to use allPages instead of filteredPages"
      },
      {
        "file": "src/tag-interaction-manager.js",
        "lines": "228-266",
        "description": "Improved representative selection: find all pages with tag, pick page with most tags"
      }
    ],
    "tests_passed": true,
    "total_tests": 38,
    "impact": "Dashboard loads correctly, L2 tags show after L1 click, similarity search uses better representative"
  },

  "lessons_learned": [
    "When refactoring to extract utilities, maintain architectural consistency (module vs script)",
    "If adding ES6 imports to a file, must load it as type='module' in HTML",
    "config-loader.js already provides global variables - use those instead of re-importing",
    "Test in browser after architectural changes, not just unit tests",
    "Tag extraction for UI should use allPages, not filtered results",
    "Representative selection for similarity search needs intelligent heuristic (best-classified page, not first page)"
  ]
}
